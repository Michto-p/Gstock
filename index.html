<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Stock CFA ‚Äî Scanner</title>
  <meta name="theme-color" content="#0ea5e9">
  <style>
    :root{
      --bg:#f6f8fa; --fg:#0b1220; --muted:#5b6b7a; --pri:#0ea5e9;
      --ok:#16a34a; --warn:#f59e0b; --err:#dc2626;
      --card:#ffffff; --bd:#e2e8f0;
      --header-h: 56px; --nav-h: 44px;
    }
    *{box-sizing:border-box}
    html,body{margin:0;height:100%}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;background:var(--bg);color:var(--fg)}
    header{position:sticky;top:0;z-index:10;height:var(--header-h);display:flex;align-items:center;gap:10px;background:linear-gradient(180deg,#ffffff,#f6f8fa);border-bottom:1px solid var(--bd);padding:0 12px}
    header h1{font-size:16px;margin:0;font-weight:700}
    header .badge{margin-left:auto;padding:2px 8px;border:1px solid var(--bd);border-radius:999px;color:var(--muted);font-size:12px;background:#fff}
    #errbar{display:none;position:sticky;top:var(--header-h);z-index:11;background:var(--err);color:#fff;padding:8px 12px;font-weight:700}
    nav{position:sticky;top:calc(var(--header-h));z-index:9;display:flex;gap:6px;padding:6px 8px;background:#fff;border-bottom:1px solid var(--bd);flex-wrap:wrap;height:var(--nav-h)}
    nav button{flex:0 0 auto;padding:6px 10px;border-radius:10px;border:1px solid var(--bd);background:#ffffff;color:var(--fg);font-weight:600;min-width:96px;font-size:13px;height:32px}
    nav button.active{outline:2px solid var(--pri);outline-offset:0}
    main{padding:12px;display:grid;gap:12px}
    .card{background:var(--card);border:1px solid var(--bd);border-radius:12px;padding:12px;box-shadow:0 1px 2px rgba(16,24,40,.04)}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    input,select,textarea{background:#fff;color:var(--fg);border:1px solid var(--bd);border-radius:10px;padding:9px 11px;width:100%}
    input[type=number]{max-width:140px}
    label{font-size:12px;color:var(--muted)}
    .btn{background:var(--pri);color:#fff;border:none;border-radius:10px;padding:9px 12px;font-weight:700}
    .btn.secondary{background:#fff;color:var(--fg);border:1px solid var(--bd)}
    .btn.warn{background:var(--warn);color:#201100}
    .btn.ok{background:var(--ok);color:#fff}
    .muted{color:var(--muted)}
    .scanbox{position:relative;border-radius:12px;overflow:hidden;border:1px dashed var(--bd);background:#000}
    video{width:100%;height:auto;display:block;background:#000}
    .overlay{position:absolute;inset:0;outline:2px dashed rgba(14,165,233,.35);pointer-events:none}
    .grid{display:grid;gap:8px}
    .two{grid-template-columns:1fr 1fr}
    .hide{display:none}
    footer{padding:20px 10px;color:var(--muted);text-align:center}
    table{width:100%;border-collapse:collapse;background:#fff}
    th,td{border-bottom:1px solid var(--bd);padding:8px;text-align:left;font-size:14px;vertical-align:top}
    th{cursor:pointer;user-select:none;background:#fafbfc}
    .nowrap{white-space:nowrap}
    .tags{display:flex;gap:6px;flex-wrap:wrap}
    .tag{background:#f1f5f9;border:1px solid var(--bd);padding:2px 6px;border-radius:999px;font-size:12px;color:#0b1220}
    .barcode-svg{max-width:220px;background:#fff;padding:4px;border-radius:6px;border:1px solid var(--bd)}
    .overdue{color:#fff;background:#ef4444;padding:2px 8px;border-radius:999px;font-size:12px}
    .dueSoon{color:#201100;background:#f59e0b;padding:2px 8px;border-radius:999px;font-size:12px}
    /* ‚ñ∂ code couleur stock */
    .lvl-ok{background:#ecfdf5}
    .lvl-warn{background:#fff7ed}
    .lvl-alert{background:#fef2f2}
    @media(min-width:900px){main{max-width:1100px;margin:0 auto}}
  </style>

  <script>
    if (location.protocol.startsWith('http')) {
      const l = document.createElement('link'); l.rel='manifest'; l.href='manifest.json'; document.head.appendChild(l);
      if ('serviceWorker' in navigator) { window.addEventListener('load', ()=>navigator.serviceWorker.register('./sw.js').catch(()=>{})); }
    }
  </script>
</head>
<body>
  <header>
    <h1>üì¶ Stock CFA ‚Äî Scanner - V 0.4</h1>
    <span class="badge" id="badge">hors ligne</span>
  </header>
  <div id="errbar"></div>

  <nav>
    <button data-tab="scan" class="active">Scanner</button>
    <button data-tab="items">Articles</button>
    <button data-tab="gear">Mat√©riel</button>
    <button data-tab="new">Nouveau</button>
    <button data-tab="labels">√âtiquettes</button>
    <button data-tab="journal">Journal</button>
    <button data-tab="settings">Param√®tres</button>
  </nav>

  <main>
    <!-- Scanner (inchang√©) -->
    <section id="tab-scan" class="card">
      <div class="row">
        <button id="modeOut" class="btn">Sortie</button>
        <button id="modeIn" class="btn secondary">Entr√©e</button>
        <div>
          <label>Quantit√©</label>
          <input id="qty" type="number" value="1" min="1" style="max-width:80px" />
        </div>
        <span id="scanStatus" class="muted">Mode: Sortie</span>
      </div>

      <div class="scanbox">
        <video id="video" muted playsinline></video>
        <div class="overlay"></div>
      </div>

      <div class="row">
        <button id="btnStartScan" class="btn">D√©marrer le scan</button>
        <button id="btnStopScan" class="btn secondary">Arr√™ter</button>
        <button id="btnTorch" class="btn secondary">üí° Lampe</button>
        <button id="btnTestDetect" class="btn secondary">Test d√©tection</button>
      </div>

      <div id="lastOp" class="muted">Pr√™t √† scanner.</div>
    </section>

    <!-- Articles -->
    <section id="tab-items" class="card hide">
  <div class="row">
    <input id="search" placeholder="Rechercher nom / code / tags" />
    <label class="row" style="align-items:center;gap:6px">
      <input type="checkbox" id="chkShowBarcodes"/>
      <span>Afficher les codes-barres</span>
    </label>
    <button id="addDummy" class="btn secondary">+ D√©mo</button>

    <!-- ‚ñ∂ Indicateur r√©assort -->
    <span id="stockBadges" class="muted" style="margin-left:auto"></span>
  </div>

  <!-- ‚ñ∂ filtre & tri par tags pr√©d√©finis + export r√©assort -->
  <div class="row">
    <label style="min-width:160px">Tag pr√©d√©fini</label>
    <select id="presetFilter" style="min-width:220px"><option value="">(Tous)</option></select>
    <label style="min-width:160px">Tri</label>
    <select id="presetSort" style="min-width:220px">
      <option value="name">Nom A‚ÜíZ</option>
      <option value="qtyAsc">Qt√© (croissant)</option>
      <option value="qtyDesc">Qt√© (d√©croissant)</option>
      <option value="status">Statut stock (critique d‚Äôabord)</option>
      <option value="tag">Tag (A‚ÜíZ)</option>
    </select>

    <button id="btnExportReassort" class="btn">Export r√©assort CSV</button>
  </div>

      <div style="overflow:auto">
        <table id="itemsTable">
          <thead>
            <tr>
              <th data-sort="name">Nom</th>
              <th data-sort="barcode">Code</th>
              <th data-sort="qty" class="nowrap">Qt√©</th>
              <th data-sort="min" class="nowrap">Seuil</th>
              <th>Tags</th>
              <th>Code-barres</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- Mat√©riel (emprunts/retours) -->
    <section id="tab-gear" class="card hide">
      <div class="row">
        <button id="gearModeBorrow" class="btn">Emprunter</button>
        <button id="gearModeReturn" class="btn secondary">Retour</button>
        <span id="gearModeText" class="muted">Mode: Emprunter</span>
      </div>
      
      <div class="grid two">
        <div>
          <label>Nom de la personne</label>
          <input id="loanWho" placeholder="Nom complet" />
        </div>
        <div>
          <label>Quantit√©</label>
          <input id="loanQty" type="number" value="1" min="1" />
        </div>
        <div>
          <label>Date limite (optionnel)</label>
          <input id="loanDue" type="date" />
        </div>
        <div>
          <label>Note (optionnel)</label>
          <input id="loanNote" placeholder="Remarques..." />
        </div>
      </div>

      <div class="scanbox">
        <video id="videoGear" muted playsinline></video>
        <div class="overlay"></div>
      </div>

      <div class="row">
        <button id="gearStart" class="btn">D√©marrer le scan</button>
        <button id="gearStop" class="btn secondary">Arr√™ter</button>
        <button id="gearTorch" class="btn secondary">üí° Lampe</button>
        <button id="gearTest" class="btn secondary">Test d√©tection</button>
      </div>

      <div id="gearLast" class="muted">Pr√™t √† scanner.</div>

      <h4>Emprunts en cours</h4>
      <div class="row">
        <input id="loanSearch" placeholder="Rechercher emprunts..." />
        <button id="btnExportLoansCsv" class="btn secondary">Export CSV</button>
      </div>
      
      <div style="overflow:auto">
        <table id="loansTable">
          <thead>
            <tr>
              <th>D√©but</th>
              <th>√âch√©ance</th>
              <th>Statut</th>
              <th>Code</th>
              <th>Nom</th>
              <th>Emprunteur</th>
              <th>Note</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- Nouveau (inchang√©) -->
    <section id="tab-new" class="card hide">
      <h3>Cr√©er un nouvel article</h3>
      <div class="grid two">
        <div>
          <label>Nom de l'article *</label>
          <input id="newName" placeholder="Ex: Multim√®tre" />
        </div>
        <div>
          <label>Code-barres (auto si vide)</label>
          <input id="newCode" placeholder="Ex: CFA-12345" />
        </div>
        <div>
          <label>Quantit√© initiale</label>
          <input id="newQty" type="number" value="0" min="0" />
        </div>
        <div>
          <label>Seuil minimum</label>
          <input id="newMin" type="number" value="5" min="0" />
        </div>
      </div>
      
      <div>
        <label>Tags (s√©par√©s par des virgules)</label>
        <input id="newTags" placeholder="Ex: atelier, mesure, outillage" />
      </div>
      
      <div class="row">
        <button id="createItem" class="btn">Cr√©er l'article</button>
      </div>
    </section>

    <!-- √âtiquettes (d√©j√† avec libell√© sous le code-barres) -->
    <section id="tab-labels" class="card hide">
      <h3>G√©n√©ration d'√©tiquettes</h3>
      <div class="row">
        <div>
          <label>Article</label>
          <select id="labelItem"></select>
        </div>
        <div>
          <label>Nombre d'√©tiquettes</label>
          <input id="labelCount" type="number" value="1" min="1" max="50" />
        </div>
        <button id="btnRenderLabel" class="btn">G√©n√©rer</button>
        <button id="btnRenderAllLabels" class="btn secondary">Tous les articles</button>
        <button id="btnPrintLabels" class="btn ok">Imprimer</button>
      </div>
      
      <div id="labelPreview"></div>
    </section>

    <!-- Journal (inchang√©) -->
    <section id="tab-journal" class="card hide">
      <h3>Journal des mouvements</h3>
      <div class="row">
        <input id="journalSearch" placeholder="Rechercher dans le journal..." />
        <button id="btnExportMovesCsv" class="btn secondary">Export CSV</button>
        <button id="btnExportMovesJson" class="btn secondary">Export JSON</button>
        <input type="file" id="fileImportMovesCsv" accept=".csv" class="hide"/>
        <button id="btnImportMovesCsv" class="btn secondary">Import CSV</button>
        <button id="btnClearMoves" class="btn warn">Vider le journal</button>
      </div>
      
      <div style="overflow:auto">
        <table id="journalTable">
          <thead>
            <tr>
              <th>Date/Heure</th>
              <th>Code</th>
              <th>Nom</th>
              <th>Œî</th>
              <th>Stock apr√®s</th>
              <th>Mode</th>
              <th>Source</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- Param√®tres -->
    <section id="tab-settings" class="card hide">
      <h3>Param√®tres & Import/Export</h3>
      <div class="row">
        <button id="btnExportItemsCsv" class="btn secondary">Export Articles CSV</button>
        <button id="btnExportItemsJson" class="btn secondary">Export Articles JSON</button>
        <input type="file" id="fileImportItemsCsv" accept=".csv,text/csv" class="hide"/>
        <button id="btnImportItemsCsv" class="btn secondary">Importer Articles CSV</button>
        <input type="file" id="fileImportJson" accept="application/json,text/json" class="hide"/>
        <button id="btnImportJson" class="btn secondary">Importer Articles JSON</button>
      </div>

      <hr style="border:none;border-top:1px solid var(--bd);margin:10px 0">

      <!-- ‚ñ∂ Tags pr√©d√©finis -->
      <h4>Tags pr√©d√©finis</h4>
      <p class="muted">Liste s√©par√©e par des virgules. Sert au filtre & tri.</p>
      <textarea id="presetTags" rows="3" placeholder="atelier, mesure, outillage, consommable"></textarea>
      <div class="row">
        <label>Marges d‚Äôalerte (approche du seuil)</label>
        <input id="warnBuffer" type="number" min="0" value="2" style="max-width:120px"/>
        <button id="btnSavePresets" class="btn ok">Enregistrer</button>
      </div>

      <hr style="border:none;border-top:1px solid var(--bd);margin:10px 0">

      <!-- ‚ñ∂ Sauvegarde via fichier -->
      <h4>Donn√©es via fichier (multi-utilisateurs)</h4>
      <div class="row">
        <button id="btnOpenDataFile" class="btn secondary">Ouvrir / cr√©er un fichier‚Ä¶</button>
        <button id="btnSaveNow" class="btn secondary">Enregistrer maintenant</button>
        <label class="row" style="align-items:center;gap:6px"><input type="checkbox" id="autoSave"/> Auto-sauvegarde</label>
        <span id="fileStatus" class="muted">Aucun fichier ouvert</span>
      </div>
      <p class="muted">Format: un seul fichier <code>stock-data.json</code> (articles, journal, pr√™ts, presets).</p>

      <hr style="border:none;border-top:1px solid var(--bd);margin:10px 0">

      <h4>Mises √† jour</h4>
      <div id="updateBox" class="row" style="align-items:center">
        <button id="btnCheckUpdate" class="btn secondary">V√©rifier les mises √† jour</button>
        <span id="updateStatus" class="muted">Version actuelle charg√©e.</span>
        <button id="btnApplyUpdate" class="btn ok hide">Mettre √† jour maintenant</button>
      </div>

      <p class="muted">Cam√©ra : HTTPS ou <code>http://localhost</code>. Version <b>BarcodeDetector only</b>.</p>
    </section>
  </main>

  <footer>Made for CFA ‚Äî PWA hors-ligne. ¬© <span id="year"></span></footer>
  <script>document.getElementById('year').textContent = new Date().getFullYear();</script>

  <script src="js/db.js?v=1.7.0"></script>
  <script src="js/barcode.js?v=1.7.0"></script>
  <script src="js/app.js?v=1.7.0"></script>

  <!-- Panneau de mise √† jour (inchang√©) -->
  <script>
    (function(){
      if (!('serviceWorker' in navigator) || !location.protocol.startsWith('http')) return;
      let reg = null; const $=(id)=>document.getElementById(id);
      const status=$('updateStatus'), btnCheck=$('btnCheckUpdate'), btnApply=$('btnApplyUpdate');
      navigator.serviceWorker.getRegistration('./sw.js').then(r=>{reg=r;wire();}).catch(()=>wire());
      function showApply(){ if(status) status.textContent='Nouvelle version disponible.'; if(btnApply) btnApply.classList.remove('hide');}
      function wire(){
        if(!reg){ if(status) status.textContent="Service Worker non actif."; return; }
        if(reg.waiting) showApply();
        reg.addEventListener('updatefound', ()=>{ const i=reg.installing; if(!i)return; i.addEventListener('statechange', ()=>{ if(i.state==='installed'&&navigator.serviceWorker.controller){ showApply(); } }); });
        if(btnCheck) btnCheck.addEventListener('click', async()=>{ if(status) status.textContent='Recherche‚Ä¶'; try{ await reg.update(); if(!reg.waiting&&status) status.textContent='Version actuelle charg√©e.'; }catch(e){ if(status) status.textContent='Erreur de v√©rification.'; } });
        if(btnApply) btnApply.addEventListener('click', ()=>{ const w=reg.waiting; if(w){ w.postMessage({type:'SKIP_WAITING'}); navigator.serviceWorker.addEventListener('controllerchange', ()=>location.reload()); } else { location.reload(); } });
      }
    })();
  </script>
</body>
</html>
