<!doctype html>
<html lang="fr" data-theme="auto">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0d9488" />
  <title>Gstock v2.9.3</title>
  <link rel="manifest" href="manifest.json?v=2.9.3">
  <link rel="icon" href="icons/icon-192.png" sizes="192x192">
  <link rel="apple-touch-icon" href="icons/icon-192.png">
  <link rel="stylesheet" href="css/styles.css?v=2.9.3" />
</head>
<body>
  <header class="topbar">
    <div class="brand">
      <strong>Gstock</strong> <span class="muted">v<span id="appVersion"></span></span>
    </div>
    <nav>
      <button data-tab="home"    title="Accueil">üè†</button>
      <button data-tab="stock"   title="Articles (Stock)">üì¶</button>
      <button data-tab="atelier" title="Mat√©riel (Atelier)">üõ†Ô∏è</button>
      <button data-tab="scanner" title="Scanner">üì∑</button>
      <button data-tab="labels"  title="√âtiquettes">üè∑Ô∏è</button>
      <button data-tab="journal" title="Journal">üßæ</button>
      <button data-tab="gear"    title="Emprunts">ü§ù</button>
      <button data-tab="settings" title="Param√®tres">‚öôÔ∏è</button>
    </nav>
    <div class="tools">
      <label class="theme">
        Th√®me
        <select id="themeToggle">
          <option value="auto">Auto</option>
          <option value="light">Clair</option>
          <option value="dark">Sombre</option>
        </select>
      </label>
    </div>
  </header>

  <main>
    <!-- ACCUEIL -->
    <section id="tab-home" class="tab">
      <h1>Accueil</h1>
      <div class="kpis">
        <div class="kpi"><div class="kpi-title">Articles</div><div id="kpiItems" class="kpi-value">0</div></div>
        <div class="kpi"><div class="kpi-title">Qt√© totale</div><div id="kpiQty" class="kpi-value">0</div></div>
        <div class="kpi warn"><div class="kpi-title">Sous seuil</div><div id="kpiUnder" class="kpi-value">0</div></div>
        <div class="kpi low"><div class="kpi-title">Approche</div><div id="kpiLow" class="kpi-value">0</div></div>
        <div class="kpi"><div class="kpi-title">Emprunts actifs</div><div id="kpiLoansActive" class="kpi-value">0</div></div>
        <div class="kpi warn"><div class="kpi-title">Retards</div><div id="kpiLoansOverdue" class="kpi-value">0</div></div>
      </div>
      <h2>Derniers mouvements</h2>
      <ul id="recentMoves" class="list slim"></ul>
    </section>

    <!-- STOCK -->
    <section id="tab-stock" class="tab" hidden>
      <h1>Articles (Stock)</h1>
      <div class="toolbar">
        <input id="stockSearch" placeholder="Rechercher nom/code/tags‚Ä¶" />
        <select id="stockStatus">
          <option value="">Tous statuts</option>
          <option value="ok">OK</option>
          <option value="low">Approche</option>
          <option value="under">Sous seuil/√âpuis√©</option>
        </select>
        <select id="stockTag"><option value="">Tous tags</option></select>
        <select id="stockLoc"><option value="">Tous emplacements</option></select>
        <button id="stockClear" class="ghost">‚úñÔ∏è</button>
        <button id="btnAddStock">‚ûï Nouvel article</button>
      </div>
      <div class="table-wrap">
        <table class="grid">
          <thead>
            <tr>
              <th>D√©signation</th>
              <th>R√©f√©rence</th>
              <th>Codebarre</th>
              <th>Quantit√©</th>
              <th>Seuil</th>
              <th>Tags</th>
              <th>Emplacement</th>
              <th>Liens</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="stockTbody"></tbody>
        </table>
      </div>
    </section>

    <!-- ATELIER -->
    <section id="tab-atelier" class="tab" hidden>
      <h1>Mat√©riel (Atelier)</h1>
      <div class="toolbar">
        <input id="atelierSearch" placeholder="Rechercher‚Ä¶" />
        <select id="atelierStatus">
          <option value="">Tous statuts</option>
          <option value="ok">OK</option>
          <option value="low">Approche</option>
          <option value="under">Sous seuil/√âpuis√©</option>
        </select>
        <select id="atelierTag"><option value="">Tous tags</option></select>
        <select id="atelierLoc"><option value="">Tous emplacements</option></select>
        <button id="atelierClear" class="ghost">‚úñÔ∏è</button>
        <button id="btnAddAtelier">‚ûï Nouveau mat√©riel</button>
      </div>
      <div class="table-wrap">
        <table class="grid">
          <thead>
            <tr>
              <th>D√©signation</th><th>R√©f√©rence</th><th>Codebarre</th><th>Quantit√©</th>
              <th>Seuil</th><th>Tags</th><th>Emplacement</th><th>Liens</th><th>Actions</th>
            </tr>
          </thead>
          <tbody id="atelierTbody"></tbody>
        </table>
      </div>
    </section>

    <!-- SCANNER -->
    <section id="tab-scanner" class="tab" hidden>
      <h1>Scanner</h1>
      <div class="scan-wrap">
        <video id="scanVideo" playsinline muted></video>
        <div class="scan-controls">
          <button id="btnScanStart">‚ñ∂Ô∏è D√©marrer</button>
          <button id="btnScanStop" hidden>‚èπÔ∏è Arr√™ter</button>
          <button id="btnScanTorch" hidden>üî¶ Lampe</button>
        </div>
        <div id="scanHint" class="muted">Autorisez la cam√©ra pour scanner.</div>
        <div id="scanFallback" class="fallback" hidden>
          <input id="scanManual" placeholder="Saisir un code‚Ä¶" />
          <button id="btnScanManual">Valider</button>
        </div>
      </div>
    </section>

    <!-- ETIQUETTES -->
    <section id="tab-labels" class="tab" hidden>
      <h1>√âtiquettes</h1>
      <div class="labels-config">
        <div class="left">
          <div class="toolbar">
            <label>Mod√®le :
              <select id="lblTemplate"></select>
            </label>
            <label>Densit√© :
              <input id="lblDensity" type="number" min="1" max="4" step="0.1" value="2" />
            </label>
            <label>Taille nom :
              <input id="lblNameSize" type="number" min="8" max="18" step="1" value="11" />
            </label>
            <label><input id="lblShowText" type="checkbox" /> Texte sous code-barres</label>
            <label>Offset X (mm) <input id="lblOffsetX" type="number" step="0.5" value="0"></label>
            <label>Offset Y (mm) <input id="lblOffsetY" type="number" step="0.5" value="0"></label>
          </div>
          <div class="toolbar">
            <input id="labelSearch" placeholder="Filtrer la liste‚Ä¶" />
            <span id="lblSelInfo" class="muted">0 s√©lection(s)</span>
            <button id="lblAll" class="ghost">Tout</button>
            <button id="lblNone" class="ghost">Aucun</button>
            <button id="btnLabelsPrint">üñ®Ô∏è Imprimer</button>
          </div>
          <div id="labelsList" class="list scroll"></div>
        </div>
        <div class="right">
          <div class="preview-head">
            <button id="lblPrev" class="ghost">‚óÄ</button>
            <span id="lblPageInfo" class="muted"></span>
            <button id="lblNext" class="ghost">‚ñ∂</button>
          </div>
          <div id="labelsPages" class="labels-pages"></div>
        </div>
      </div>
    </section>

    <!-- JOURNAL -->
    <section id="tab-journal" class="tab" hidden>
      <h1>Journal</h1>
      <div class="toolbar">
        <label>Du <input id="dateFrom" type="date"></label>
        <label>au <input id="dateTo" type="date"></label>
        <button id="btnFilterJournal">Filtrer</button>
        <span class="spacer"></span>
        <button id="btnExportCSV" class="ghost">Exporter CSV</button>
        <button id="btnExportJSON" class="ghost">Exporter JSON</button>
      </div>
      <div class="table-wrap">
        <table class="grid">
          <thead><tr><th>Date</th><th>Type</th><th>Code</th><th>Nom</th><th>Qt√©</th><th>Note</th></tr></thead>
          <tbody id="journalTbody"></tbody>
        </table>
      </div>
    </section>

    <!-- EMPRUNTS -->
    <section id="tab-gear" class="tab" hidden>
      <h1>Emprunts</h1>
      <div class="toolbar">
        <button id="btnNewLoan">‚ûï Nouvel emprunt</button>
        <button id="btnScanBorrow">üì∑ Scanner un emprunt</button>
        <button id="btnScanReturn">üì∑ Scanner un retour</button>
        <span class="spacer"></span>
        <input id="searchLoans" placeholder="Rechercher‚Ä¶" />
      </div>
      <div class="table-wrap">
        <table class="grid">
          <thead><tr><th>Article</th><th>Code</th><th>Emprunteur</th><th>Retour pr√©vu</th><th>Statut</th><th>Action</th></tr></thead>
          <tbody id="loansTbody"></tbody>
        </table>
      </div>
    </section>

    <!-- PARAMETRES -->
    <section id="tab-settings" class="tab" hidden>
      <h1>Param√®tres</h1>
      <article class="help">
        <h3>Aide int√©gr√©e</h3>
        <p>Gstock fonctionne hors-ligne. Utilisez le scanner (üì∑) pour ajouter/retirer rapidement des quantit√©s. Les codes-barres sont normalis√©s automatiquement (A-Z/0-9, max 10).</p>
        <p>Les statuts de stock : <span class="badge ok">OK</span> quand au-dessus du seuil + buffer, <span class="badge low">Approche</span> quand proche du seuil (‚â§ buffer), <span class="badge under">Sous seuil</span> ou √©puis√©.</p>
        <p>Les √©tiquettes (üè∑Ô∏è) proposent des mod√®les (dont A4 3√ó8). L‚Äôimpression se fait dans une fen√™tre d√©di√©e sans l‚ÄôUI.</p>
        <p>En cas de souci de cache, ajoutez <code>?safe=1</code> √† l‚ÄôURL pour purger SW/IDB.</p>
      </article>

      <div class="settings-grid">
        <div>
          <h3>Tags (Stock) <small><span id="countTagsStock">0</span></small></h3>
          <div class="row-add">
            <input id="addTagStock" placeholder="Nouveau tag‚Ä¶" />
            <button id="btnAddTagStock">Ajouter</button>
          </div>
          <ul id="listTagsStock" class="sortable"></ul>
        </div>
        <div>
          <h3>Tags (Atelier) <small><span id="countTagsAtelier">0</span></small></h3>
          <div class="row-add">
            <input id="addTagAtelier" placeholder="Nouveau tag‚Ä¶" />
            <button id="btnAddTagAtelier">Ajouter</button>
          </div>
          <ul id="listTagsAtelier" class="sortable"></ul>
        </div>
        <div>
          <h3>Emplacements (Stock) <small><span id="countLocsStock">0</span></small></h3>
          <div class="row-add">
            <input id="addLocStock" placeholder="Ex. Atelier/√âtag√®re 1‚Ä¶" />
            <button id="btnAddLocStock">Ajouter</button>
          </div>
          <ul id="listLocsStock" class="sortable"></ul>
        </div>
        <div>
          <h3>Emplacements (Atelier) <small><span id="countLocsAtelier">0</span></small></h3>
          <div class="row-add">
            <input id="addLocAtelier" placeholder="Ex. Atelier/√âtag√®re 1‚Ä¶" />
            <button id="btnAddLocAtelier">Ajouter</button>
          </div>
          <ul id="listLocsAtelier" class="sortable"></ul>
        </div>
      </div>

      <div class="toolbar">
        <label>Buffer alerte (pi√®ces) <input id="inputBuffer" type="number" min="0" step="1" value="0"></label>
        <label><input id="chkDebug" type="checkbox"> Mode debug</label>
        <span class="spacer"></span>
        <button id="btnSaveSettings">üíæ Enregistrer</button>
        <button id="btnExportFull" class="ghost">Exporter (tout)</button>
        <button id="btnImportJSON" class="ghost">Importer (JSON)</button>
        <button id="btnLinkSharedFile" class="ghost">Lier fichier partag√©</button>
        <span id="sharedFileStatus" class="muted"></span>
        <button id="btnResetCache" class="danger">Purgez SW/IDB</button>
      </div>
    </section>
  </main>

  <!-- DIALOG: Ajustement -->
  <dialog id="adjustDialog">
    <form method="dialog">
      <h3>Ajuster les quantit√©s</h3>
      <div id="dlgItem" class="muted"></div>
      <div class="row">
        <label>Type
          <select id="dlgType">
            <option value="add">Ajout</option>
            <option value="remove">Retrait</option>
          </select>
        </label>
        <label>Quantit√© <input id="dlgQty" type="number" min="1" step="1" value="1"></label>
      </div>
      <label>Note <input id="dlgNote" placeholder="Optionnel‚Ä¶"></label>
      <menu>
        <button id="dlgClose" class="ghost">Annuler</button>
        <button id="dlgValidate">Valider</button>
      </menu>
    </form>
  </dialog>

  <!-- DIALOG: Cr√©ation/√âdition -->
  <dialog id="newItemDialog">
    <form method="dialog">
      <h3 id="niTitle">Nouvel article</h3>
      <div class="row">
        <label>Type
          <select id="niType">
            <option value="stock">Stock</option>
            <option value="atelier">Atelier</option>
          </select>
        </label>
        <label>D√©signation <input id="niName" required></label>
      </div>
      <div class="row">
        <label>R√©f√©rence <input id="niRef" placeholder="ex: cat interne"></label>
        <label>Code <input id="niCode" placeholder="Auto si vide (A-Z0-9)"></label>
        <button id="niGen" type="button" class="ghost">Auto</button>
        <button id="niCopyRefToCode" type="button" class="ghost">Ref ‚Üí Code</button>
      </div>
      <div class="row">
        <label>Qt√© <input id="niQty" type="number" min="0" step="1" value="0"></label>
        <label>Seuil <input id="niThr" type="number" min="0" step="1" value="0"></label>
      </div>
      <fieldset>
        <legend>Emplacement</legend>
        <div class="row">
          <select id="niLocSelect"></select>
          <div id="niLocCustomWrap">
            <input id="niLocCustom" placeholder="Saisir personnalis√©‚Ä¶" />
          </div>
        </div>
        <div id="niLocChips" class="chips"></div>
      </fieldset>
      <fieldset>
        <legend>Tags <small class="muted" id="niTagCategory"></small></legend>
        <div id="niTagChecks" class="chips"></div>
        <div class="row">
          <input id="niTagsExtra" placeholder="Tags suppl√©mentaires (s√©par√©s par des virgules)‚Ä¶" />
          <button id="niTagsClear" type="button" class="ghost">Tout d√©cocher</button>
        </div>
      </fieldset>
      <fieldset>
        <legend>Liens</legend>
        <textarea id="niLinks" rows="3" placeholder="Un lien par ligne (fournisseur, fiche, doc)‚Ä¶"></textarea>
      </fieldset>
      <menu>
        <button class="ghost" onclick="this.closest('dialog').close()">Annuler</button>
        <button id="niSave">Enregistrer</button>
      </menu>
    </form>
  </dialog>

  <!-- DIALOG: Scan pr√™t/retour -->
  <dialog id="loanScanDialog">
    <form method="dialog">
      <h3 id="loanScanTitle">Scanner</h3>
      <video id="loanVideo" playsinline muted></video>
      <div class="scan-controls">
        <button id="btnLoanTorch" type="button">üî¶</button>
        <button id="btnLoanStop" type="button">‚èπÔ∏è</button>
      </div>
      <div id="loanScanHint" class="muted"></div>
    </form>
  </dialog>

  <!-- DIALOG: Cr√©ation pr√™t -->
  <dialog id="borrowDialog">
    <form method="dialog">
      <h3>Cr√©er un pr√™t</h3>
      <div id="borrowItem" class="muted"></div>
      <div class="row">
        <label>Emprunteur <input id="brwPerson" required></label>
        <label>Retour pr√©vu <input id="brwDue" type="date" required></label>
      </div>
      <label>Note <input id="brwNote" placeholder="Optionnel‚Ä¶"></label>
      <menu>
        <button class="ghost" onclick="this.closest('dialog').close()">Annuler</button>
        <button id="brwCreate">Cr√©er</button>
      </menu>
    </form>
  </dialog>

  <div id="sr" class="sr" aria-live="polite" aria-atomic="true"></div>

  <script>window.APP_VERSION="2.9.3";</script>
  <script src="js/code39.js?v=2.9.3"></script>
  <script src="js/db.js?v=2.9.3"></script>
  <script src="js/app.js?v=2.9.3"></script>
  <script>
  // Enregistrement SW (r√©seau-first, cache l√©ger)
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('sw.js?v=2.9.3').catch(e=>{
        console.warn('SW non enregistr√©:', e);
      });
    });
  }
  </script>
</body>
</html>
