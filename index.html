<!doctype html>
<html lang="fr" data-theme="auto">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <meta name="theme-color" content="#111827">
  <title>Gstock ‚Äì Gestion de stock</title>

  <!-- Favicon inline (√©vite 404) -->
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Crect width='32' height='32' fill='%23111827'/%3E%3Ctext x='7' y='22' font-size='16' fill='%23fff'%3EG%3C/text%3E%3C/svg%3E">

  <!-- PWA -->
  <link rel="manifest" href="manifest.json?v=2.9.0">

  <!-- Styles -->
  <link rel="stylesheet" href="css/styles.css?v=2.9.0">
</head>
<body>
  <header class="topbar">
    <div class="brand">
      <span class="logo">üì¶</span>
      <strong>Gstock</strong>
      <small class="muted">v<span id="appVersion">2.9.0</span></small>
    </div>
    <div class="grow"></div>
    <div class="theme">
      <label for="themeToggle" class="muted">Th√®me</label>
      <select id="themeToggle" title="Th√®me">
        <option value="auto">Auto</option>
        <option value="light">Clair</option>
        <option value="dark">Sombre</option>
      </select>
    </div>
  </header>

  <nav class="tabs">
    <button data-tab="home"    title="Accueil">üè† Accueil</button>
    <button data-tab="stock"   title="Stock">üìã Stock</button>
    <button data-tab="atelier" title="Atelier">üõ†Ô∏è Atelier</button>
    <button data-tab="scanner" title="Scanner">üì∑ Scanner</button>
    <button data-tab="labels"  title="√âtiquettes">üè∑Ô∏è √âtiquettes</button>
    <button data-tab="journal" title="Journal">üßæ Journal</button>
    <button data-tab="gear"    title="Emprunts">üìá Emprunts</button>
    <button data-tab="settings"title="Param√®tres">‚öôÔ∏è Param√®tres</button>
  </nav>

  <main>
    <!-- ACCUEIL -->
    <section id="tab-home" hidden>
      <h2>Tableau de bord</h2>
      <div class="kpis">
        <div class="kpi"><div class="kpi-num" id="kpiItems">0</div><div class="kpi-label">Articles</div></div>
        <div class="kpi"><div class="kpi-num" id="kpiQty">0</div><div class="kpi-label">Quantit√© totale</div></div>
        <div class="kpi"><div class="kpi-num warn" id="kpiLow">0</div><div class="kpi-label">Approche</div></div>
        <div class="kpi"><div class="kpi-num danger" id="kpiUnder">0</div><div class="kpi-label">Sous seuil</div></div>
        <div class="kpi"><div class="kpi-num" id="kpiLoansActive">0</div><div class="kpi-label">Emprunts actifs</div></div>
        <div class="kpi"><div class="kpi-num danger" id="kpiLoansOverdue">0</div><div class="kpi-label">Retards</div></div>
      </div>

      <h3>Derniers mouvements</h3>
      <ul id="recentMoves" class="list"></ul>
    </section>

    <!-- STOCK -->
    <section id="tab-stock" hidden>
      <div class="panel-head">
        <h2>Stock</h2>
        <div class="panel-actions">
          <input id="stockSearch" type="search" placeholder="Rechercher (nom, ref, code, tag, lien‚Ä¶)">
          <select id="stockStatus" title="Filtrer par statut">
            <option value="">Tous statuts</option>
            <option value="ok">OK</option>
            <option value="low">Approche</option>
            <option value="under">Sous seuil</option>
          </select>
          <select id="stockTag" title="Filtrer par tag"></select>
          <select id="stockLoc" title="Filtrer par emplacement"></select>
          <button id="stockClear" class="btn">‚ôªÔ∏è Effacer filtres</button>
          <button id="btnAddStock" class="btn primary">‚ûï Nouvel article</button>
        </div>
      </div>
      <div class="table-wrap">
        <table class="table">
          <thead>
            <tr>
              <th>Designation</th>
              <th>R√©f√©rence</th>
              <th>Codebarre</th>
              <th>Quantit√©</th>
              <th>Seuil</th>
              <th>Tags</th>
              <th>Emplacement</th>
              <th>Liens</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="stockTbody"></tbody>
        </table>
      </div>
    </section>

    <!-- ATELIER -->
    <section id="tab-atelier" hidden>
      <div class="panel-head">
        <h2>Atelier</h2>
        <div class="panel-actions">
          <input id="atelierSearch" type="search" placeholder="Rechercher (nom, ref, code, tag, lien‚Ä¶)">
          <select id="atelierStatus">
            <option value="">Tous statuts</option>
            <option value="ok">OK</option>
            <option value="low">Approche</option>
            <option value="under">Sous seuil</option>
          </select>
          <select id="atelierTag"></select>
          <select id="atelierLoc"></select>
          <button id="atelierClear" class="btn">‚ôªÔ∏è Effacer filtres</button>
          <button id="btnAddAtelier" class="btn primary">‚ûï Nouveau mat√©riel</button>
        </div>
      </div>
      <div class="table-wrap">
        <table class="table">
          <thead>
            <tr>
              <th>Designation</th>
              <th>R√©f√©rence</th>
              <th>Codebarre</th>
              <th>Quantit√©</th>
              <th>Seuil</th>
              <th>Tags</th>
              <th>Emplacement</th>
              <th>Liens</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="atelierTbody"></tbody>
        </table>
      </div>
    </section>

    <!-- SCANNER -->
    <section id="tab-scanner" hidden>
      <h2>Scanner un article</h2>
      <div class="scanner">
        <video id="scanVideo" playsinline></video>
        <div class="scan-actions">
          <button id="btnScanStart" class="btn primary">‚ñ∂Ô∏è D√©marrer</button>
          <button id="btnScanStop" class="btn">‚èπÔ∏è Stop</button>
          <button id="btnScanTorch" class="btn">üî¶ Lampe</button>
        </div>
        <p id="scanHint" class="muted"></p>

        <!-- Fallback si pas de BarcodeDetector -->
        <div id="scanFallback" class="scan-fallback" hidden>
          <div class="inline">
            <input id="scanManual" placeholder="Saisir / coller un code-barres">
            <button id="btnScanManual" class="btn">Valider</button>
          </div>
          <p class="muted">Scanner natif indisponible sur ce navigateur. Utilisez la saisie ci-dessus.</p>
        </div>
      </div>
    </section>

    <!-- √âTIQUETTES -->
    <section id="tab-labels" hidden>
      <h2>√âtiquettes</h2>
      <div class="labels-grid">
        <aside class="labels-left">
          <div class="form-row">
            <input id="labelSearch" type="search" placeholder="Filtrer par nom, code, tag‚Ä¶">
            <div class="btns">
              <button id="lblAll" class="btn">Tout</button>
              <button id="lblNone" class="btn">Aucun</button>
            </div>
          </div>

          <div class="form-row">
            <label>Mod√®le</label>
            <select id="lblTemplate">
              <option value="avery-l7160">Avery L7160 (3√ó7)</option>
              <option value="avery-l7159">Avery L7159 (3√ó7)</option>
              <option value="avery-l7163">Avery L7163 (2√ó7)</option>
              <option value="avery-l7162">Avery L7162 (2√ó8)</option>
              <option value="avery-l7165">Avery L7165 (2√ó4)</option>
              <option value="mm50x25">50√ó25 mm (4√ó10)</option>
              <option value="mm70x35">70√ó35 mm (3√ó8)</option>
            </select>
          </div>

          <div class="form-grid-2">
            <label>√âpaisseur barres (px/mm)
              <input id="lblDensity" type="number" step="0.1" min="0.6" value="2">
            </label>
            <label>Taille nom (pt)
              <input id="lblNameSize" type="number" min="8" value="11">
            </label>
            <label>Afficher le texte
              <input id="lblShowText" type="checkbox">
            </label>
            <div></div>
            <label>D√©calage X (mm)
              <input id="lblOffsetX" type="number" step="0.1" value="0">
            </label>
            <label>D√©calage Y (mm)
              <input id="lblOffsetY" type="number" step="0.1" value="0">
            </label>
          </div>

          <p class="muted"><span id="lblSelInfo">0 s√©lection</span></p>
          <div id="labelsList" class="list scroll"></div>

          <div class="print-actions">
            <button id="btnLabelsPrint" class="btn primary">üñ®Ô∏è Imprimer ces √©tiquettes</button>
          </div>
        </aside>

        <div class="labels-right">
          <div class="labels-preview">
            <div class="labels-pages" id="labelsPages"></div>
          </div>
          <div class="pager">
            <button id="lblPrev" class="btn">‚óÄ</button>
            <span id="lblPageInfo" class="muted"></span>
            <button id="lblNext" class="btn">‚ñ∂</button>
          </div>
        </div>
      </div>
    </section>

    <!-- JOURNAL -->
    <section id="tab-journal" hidden>
      <div class="panel-head">
        <h2>Journal des mouvements</h2>
        <div class="panel-actions">
          <input type="date" id="dateFrom">
          <input type="date" id="dateTo">
          <button id="btnFilterJournal" class="btn">Filtrer</button>
          <button id="btnExportCSV" class="btn">‚¨áÔ∏è CSV</button>
          <button id="btnExportJSON" class="btn">‚¨áÔ∏è JSON</button>
        </div>
      </div>
      <div class="table-wrap">
        <table class="table">
          <thead><tr><th>Date</th><th>Type</th><th>Code</th><th>Nom</th><th>Qt√©</th><th>Note</th></tr></thead>
          <tbody id="journalTbody"></tbody>
        </table>
      </div>
    </section>

    <!-- EMPRUNTS -->
    <section id="tab-gear" hidden>
      <div class="panel-head">
        <h2>Emprunts</h2>
        <div class="panel-actions">
          <input id="searchLoans" type="search" placeholder="Filtrer emprunts (nom, code, personne)">
          <button id="btnNewLoan" class="btn primary">‚ûï Nouvel emprunt</button>
          <button id="btnScanBorrow" class="btn">üì∑ Scanner emprunt</button>
          <button id="btnScanReturn" class="btn">üì∑ Scanner retour</button>
        </div>
      </div>
      <div class="table-wrap">
        <table class="table">
          <thead><tr><th>Article</th><th>Code</th><th>Emprunteur</th><th>Retour pr√©vu</th><th>Statut</th><th>Action</th></tr></thead>
          <tbody id="loansTbody"></tbody>
        </table>
      </div>
    </section>

    <!-- PARAM√àTRES -->
    <section id="tab-settings" hidden>
      <h2>Param√®tres</h2>

      <details open>
        <summary>Guide rapide</summary>
        <div class="help">
          <p>Bienvenue dans <strong>Gstock</strong> : scannez un article, ajustez les quantit√©s, imprimez des √©tiquettes, et suivez les emprunts.</p>
          <p><strong>Scanner</strong> : bouton ‚ÄúD√©marrer‚Äù ‚Üí bip si l‚Äôarticle est reconnu ‚Üí fen√™tre d‚Äôajustement.</p>
          <p><strong>√âtiquettes</strong> : s√©lection multi, choix du mod√®le, aper√ßu pagin√© A4, impression sans l‚ÄôUI.</p>
          <p><strong>Tags / Emplacements</strong> : g√©rez des listes triables (glisser/d√©poser), r√©utilis√©es √† la cr√©ation.</p>
        </div>
      </details>

      <div class="settings-grid">
        <section>
          <h3>Tags pr√©d√©finis ‚Äì Stock (<span id="countTagsStock">0</span>)</h3>
          <div class="list-editor">
            <input id="addTagStock" placeholder="Ajouter un tag‚Ä¶">
            <button id="btnAddTagStock" class="btn">Ajouter</button>
            <ul id="listTagsStock" class="sortable"></ul>
          </div>
        </section>

        <section>
          <h3>Tags pr√©d√©finis ‚Äì Atelier (<span id="countTagsAtelier">0</span>)</h3>
          <div class="list-editor">
            <input id="addTagAtelier" placeholder="Ajouter un tag‚Ä¶">
            <button id="btnAddTagAtelier" class="btn">Ajouter</button>
            <ul id="listTagsAtelier" class="sortable"></ul>
          </div>
        </section>

        <section>
          <h3>Emplacements ‚Äì Stock (<span id="countLocsStock">0</span>)</h3>
          <div class="list-editor">
            <input id="addLocStock" placeholder="Ajouter un emplacement‚Ä¶">
            <button id="btnAddLocStock" class="btn">Ajouter</button>
            <ul id="listLocsStock" class="sortable"></ul>
          </div>
        </section>

        <section>
          <h3>Emplacements ‚Äì Atelier (<span id="countLocsAtelier">0</span>)</h3>
          <div class="list-editor">
            <input id="addLocAtelier" placeholder="Ajouter un emplacement‚Ä¶">
            <button id="btnAddLocAtelier" class="btn">Ajouter</button>
            <ul id="listLocsAtelier" class="sortable"></ul>
          </div>
        </section>
      </div>

      <div class="settings-row">
        <label>Buffer d‚Äôalerte (√©cart au seuil pour ‚ÄúApproche‚Äù)
          <input id="inputBuffer" type="number" min="0" value="0">
        </label>
        <label class="switch">
          <input id="chkDebug" type="checkbox"> Mode d√©veloppeur (logs scanner, etc.)
        </label>
      </div>

      <div class="settings-actions">
        <button id="btnLinkSharedFile" class="btn">Lier un fichier partag√© (JSON)</button>
        <span id="sharedFileStatus" class="muted"></span>
        <div class="grow"></div>
        <button id="btnExportFull" class="btn">Exporter toutes les donn√©es</button>
        <button id="btnImportJSON" class="btn">Importer un JSON</button>
        <button id="btnResetCache" class="btn danger">R√©initialiser (IDB+SW+cache)</button>
        <button id="btnSaveSettings" class="btn primary">üíæ Enregistrer</button>
      </div>
    </section>
  </main>

  <!-- Dialogs -->
  <dialog id="adjustDialog" class="dialog">
    <h3 id="dlgItem">Ajuster</h3>
    <div class="grid-2">
      <label>Type
        <select id="dlgType">
          <option value="add">Entr√©e</option>
          <option value="remove">Sortie</option>
        </select>
      </label>
      <label>Quantit√©
        <input id="dlgQty" type="number" min="1" value="1">
      </label>
    </div>
    <label>Note (optionnel)
      <input id="dlgNote" placeholder="Commentaire‚Ä¶">
    </label>
    <footer class="dialog-actions">
      <button id="dlgClose" class="btn">Annuler</button>
      <button id="dlgValidate" class="btn primary">Valider</button>
    </footer>
  </dialog>

  <dialog id="newItemDialog" class="dialog">
    <h3 id="niTitle">Nouvel article</h3>
    <label>Type
      <select id="niType"><option value="stock">Stock</option><option value="atelier">Atelier</option></select>
    </label>
    <label>Designation <input id="niName" required placeholder="ex. Disjoncteur 20 A XP Legrand"></label>
    <div class="grid-2">
      <label>R√©f√©rence <input id="niRef" placeholder="ex. disj20xpLeg"></label>
      <label>Code-barres
        <div class="inline">
          <input id="niCode" placeholder="Valeur scann√©e ou g√©n√©r√©e">
          <button id="niCopyRefToCode" class="btn">‚Æï Copier la r√©f.</button>
          <button id="niGen" class="btn">‚ú® G√©n√©rer</button>
        </div>
      </label>
    </div>
    <div class="grid-2">
      <label>Quantit√© <input id="niQty" type="number" min="0" value="0"></label>
      <label>Seuil <input id="niThr" type="number" min="0" value="0"></label>
    </div>
    <fieldset>
      <legend>Emplacement</legend>
      <div class="inline">
        <select id="niLocSelect"></select>
        <div id="niLocCustomWrap"><input id="niLocCustom" placeholder="Saisir un emplacement‚Ä¶"></div>
      </div>
      <div id="niLocChips" class="chips"></div>
    </fieldset>
    <fieldset>
      <legend>Tags <small class="muted">cat√©gorie: <span id="niTagCategory">Stock</span></small></legend>
      <div id="niTagChecks" class="chips"></div>
      <div class="inline">
        <input id="niTagsExtra" placeholder="Tags suppl√©mentaires (virgules)">
        <button id="niTagsClear" class="btn">Effacer s√©lection</button>
      </div>
    </fieldset>
    <label>Liens (un par ligne)<textarea id="niLinks" rows="3" placeholder="https://‚Ä¶"></textarea></label>
    <footer class="dialog-actions">
      <button class="btn" onclick="document.getElementById('newItemDialog').close()">Annuler</button>
      <button id="niSave" class="btn primary">Cr√©er</button>
    </footer>
  </dialog>

  <dialog id="loanScanDialog" class="dialog">
    <h3 id="loanScanTitle">Scanner</h3>
    <video id="loanVideo" playsinline></video>
    <div class="scan-actions">
      <button id="btnLoanTorch" class="btn">üî¶ Lampe</button>
      <button id="btnLoanStop" class="btn">‚èπÔ∏è Stop</button>
    </div>
    <p id="loanScanHint" class="muted"></p>
  </dialog>

  <dialog id="borrowDialog" class="dialog">
    <h3>Nouvel emprunt</h3>
    <p id="borrowItem" class="muted"></p>
    <div class="grid-2">
      <label>Emprunteur <input id="brwPerson" placeholder="Nom de l'emprunteur"></label>
      <label>Retour pr√©vu <input id="brwDue" type="date"></label>
    </div>
    <label>Note <input id="brwNote" placeholder="Commentaire (optionnel)"></label>
    <footer class="dialog-actions">
      <button class="btn" onclick="document.getElementById('borrowDialog').close()">Annuler</button>
      <button id="brwCreate" class="btn primary">Cr√©er</button>
    </footer>
  </dialog>

  <!-- Live region -->
  <div id="sr" class="sr-only" aria-live="polite"></div>

  <!-- Scripts (ordre important) -->
  <script>window.APP_VERSION="2.9.0";</script>
  <script src="js/code39.js?v=2.9.0"></script>
  <script src="js/db.js?v=2.9.0"></script>
  <script src="js/app.js?v=2.9.0"></script>

  <!-- Service Worker : enregistrement conditionnel -->
  <script>
  (async () => {
    if (!('serviceWorker' in navigator)) return;
    // Ne pas enregistrer SW si le stockage est indisponible (√©vite AbortError)
    async function canUseCache() {
      try { const c = await caches.open('gstock-sw-test'); await c.put(new Request('./'), new Response('ok')); await caches.delete('gstock-sw-test'); return true; }
      catch(e){ console.warn('CacheStorage indisponible:', e); return false; }
    }
    const ok = await canUseCache();
    if (!ok) return; // skip SW
    try {
      await navigator.serviceWorker.register('sw.js?v=2.9.0', { scope: './' });
    } catch (e) {
      console.warn('SW non enregistr√©:', e);
    }
  })();
  </script>
</body>
</html>
