<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Stock CFA ‚Äî Scanner</title>
  <meta name="theme-color" content="#0ea5e9">
  <style>
    /* ===== Th√®me clair, lisible ===== */
    :root{
      --bg:#f6f8fa; --fg:#0b1220; --muted:#5b6b7a; --pri:#0ea5e9;
      --ok:#16a34a; --warn:#f59e0b; --err:#dc2626;
      --card:#ffffff; --bd:#e2e8f0;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;background:var(--bg);color:var(--fg)}
    header{position:sticky;top:0;background:linear-gradient(180deg,#ffffff,#f6f8fa);border-bottom:1px solid var(--bd);padding:8px 10px;display:flex;align-items:center;gap:10px;z-index:5}
    header h1{font-size:16px;margin:0;font-weight:700}
    header .badge{margin-left:auto;padding:2px 8px;border:1px solid var(--bd);border-radius:999px;color:var(--muted);font-size:12px;background:#fff}
    #errbar{display:none;position:sticky;top:44px;z-index:6;background:var(--err);color:#fff;padding:8px 12px;font-weight:700}

    /* ===== Onglets plus compacts ===== */
    nav{display:flex;gap:6px;padding:6px;border-bottom:1px solid var(--bd);background:#fff;position:sticky;top:76px;z-index:4;flex-wrap:wrap}
    nav button{
      flex:0 0 auto; padding:6px 10px; border-radius:10px; border:1px solid var(--bd);
      background:#ffffff; color:var(--fg); font-weight:600; min-width:96px; font-size:13px;
    }
    nav button.active{outline:2px solid var(--pri); outline-offset:0}

    main{padding:10px;display:grid;gap:10px}
    .card{background:var(--card);border:1px solid var(--bd);border-radius:12px;padding:12px;box-shadow:0 1px 2px rgba(16,24,40,.04)}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    input,select,textarea{background:#fff;color:var(--fg);border:1px solid var(--bd);border-radius:10px;padding:9px 11px;width:100%}
    input[type=number]{max-width:140px}
    label{font-size:12px;color:var(--muted)}
    .btn{background:var(--pri);color:#fff;border:none;border-radius:10px;padding:9px 12px;font-weight:700}
    .btn.secondary{background:#fff;color:var(--fg);border:1px solid var(--bd)}
    .btn.warn{background:var(--warn);color:#201100}
    .btn.ok{background:var(--ok);color:#fff}
    .muted{color:var(--muted)}
    .warntext{color:var(--warn);font-weight:700}
    .oktext{color:var(--ok);font-weight:700}
    .scanbox{position:relative;border-radius:12px;overflow:hidden;border:1px dashed var(--bd);background:#000}
    video{width:100%;height:auto;display:block;background:#000}
    .overlay{position:absolute;inset:0;outline:2px dashed rgba(14,165,233,.35);pointer-events:none}
    .grid{display:grid;gap:8px}
    .two{grid-template-columns:1fr 1fr}
    .hide{display:none}
    footer{padding:20px 10px;color:var(--muted);text-align:center}
    table{width:100%;border-collapse:collapse;background:#fff}
    th,td{border-bottom:1px solid var(--bd);padding:8px;text-align:left;font-size:14px;vertical-align:top}
    th{cursor:pointer;user-select:none;background:#fafbfc}
    .nowrap{white-space:nowrap}
    .tags{display:flex;gap:6px;flex-wrap:wrap}
    .tag{background:#f1f5f9;border:1px solid var(--bd);padding:2px 6px;border-radius:999px;font-size:12px;color:#0b1220}
    .barcode-svg{max-width:220px;background:#fff;padding:4px;border-radius:6px;border:1px solid var(--bd)}
    .overdue{color:#fff;background:#ef4444;padding:2px 8px;border-radius:999px;font-size:12px}
    .dueSoon{color:#201100;background:#f59e0b;padding:2px 8px;border-radius:999px;font-size:12px}
    @media(min-width:900px){main{max-width:1100px;margin:0 auto}}
  </style>

  <!-- PWA: manifest + SW registration (mise √† jour via Param√®tres) -->
  <script>
    if (location.protocol.startsWith('http')) {
      const l = document.createElement('link'); l.rel='manifest'; l.href='manifest.json'; document.head.appendChild(l);
      // On enregistre le SW; l‚ÄôUI d‚Äôupdate est contr√¥l√©e depuis l‚Äôonglet Param√®tres (voir script en bas)
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', ()=>navigator.serviceWorker.register('./sw.js').catch(()=>{}));
      }
    }
  </script>
</head>
<body>
  <header>
    <h1>üì¶ Stock CFA ‚Äî Scanner</h1>
    <span class="badge" id="badge">hors ligne</span>
  </header>
  <div id="errbar"></div>

  <nav>
    <button data-tab="scan" class="active">Scanner</button>
    <button data-tab="items">Articles</button>
    <button data-tab="gear">Mat√©riel</button>
    <button data-tab="new">Nouveau</button>
    <button data-tab="labels">√âtiquettes</button>
    <button data-tab="journal">Journal</button>
    <button data-tab="settings">Param√®tres</button>
  </nav>

  <main>
    <!-- Scanner -->
    <section id="tab-scan" class="card">
      <div class="grid">
        <div class="row">
          <button class="pill" id="modeOut">‚àí Sortie</button>
          <button class="pill" id="modeIn">+ Entr√©e</button>
          <span class="pill" id="scanStatus">Mode: Sortie</span>
          <span class="muted">(BarcodeDetector)</span>
        </div>
        <div class="row">
          <button id="btnStartScan" class="btn secondary">D√©marrer cam√©ra</button>
          <button id="btnStopScan" class="btn secondary">Arr√™ter</button>
          <button id="btnTorch" class="btn secondary">Lampe</button>
          <button id="btnTestDetect" class="btn secondary">Tester une d√©tection</button>
        </div>
        <div class="scanbox">
          <video id="video" playsinline muted></video>
          <div class="overlay"></div>
        </div>
        <div class="row">
          <label>Quantit√©</label>
          <input type="number" id="qty" value="1" min="1" step="1"/>
        </div>
        <div id="lastOp" class="muted"></div>
      </div>
    </section>

    <!-- Articles -->
    <section id="tab-items" class="card hide">
      <div class="row">
        <input id="search" placeholder="Rechercher nom / code / tags" />
        <label class="row" style="align-items:center;gap:6px">
          <input type="checkbox" id="chkShowBarcodes"/>
          <span>Afficher les codes-barres</span>
        </label>
        <button id="addDummy" class="btn secondary">+ D√©mo</button>
      </div>
      <div style="overflow:auto">
        <table id="itemsTable">
          <thead>
            <tr>
              <th data-sort="name">Nom</th>
              <th data-sort="barcode">Code</th>
              <th data-sort="qty" class="nowrap">Qt√©</th>
              <th data-sort="min" class="nowrap">Seuil</th>
              <th>Tags</th>
              <th>Code-barres</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- Mat√©riel (emprunts/retours) -->
    <section id="tab-gear" class="card hide">
      <!-- (conserve exactement le contenu que je t‚Äôai donn√© en v1.5.0) -->
      <!-- ‚Ä¶ -->
    </section>

    <!-- Nouveau -->
    <section id="tab-new" class="card hide">
      <!-- (inchang√©) -->
    </section>

    <!-- √âtiquettes -->
    <section id="tab-labels" class="card hide">
      <!-- (inchang√©) -->
    </section>

    <!-- Journal -->
    <section id="tab-journal" class="card hide">
      <!-- (inchang√©) -->
    </section>

    <!-- Param√®tres -->
    <section id="tab-settings" class="card hide">
      <h3>Param√®tres & Import/Export</h3>
      <div class="row">
        <button id="btnExportItemsCsv" class="btn secondary">Export Articles CSV</button>
        <button id="btnExportItemsJson" class="btn secondary">Export Articles JSON</button>
        <input type="file" id="fileImportItemsCsv" accept=".csv,text/csv" class="hide"/>
        <button id="btnImportItemsCsv" class="btn secondary">Importer Articles CSV</button>
        <input type="file" id="fileImportJson" accept="application/json,text/json" class="hide"/>
        <button id="btnImportJson" class="btn secondary">Importer Articles JSON</button>
      </div>

      <hr style="border:none;border-top:1px solid var(--bd);margin:10px 0">

      <h4>Mises √† jour</h4>
      <div id="updateBox" class="row" style="align-items:center">
        <button id="btnCheckUpdate" class="btn secondary">V√©rifier les mises √† jour</button>
        <span id="updateStatus" class="muted">Version actuelle charg√©e.</span>
        <button id="btnApplyUpdate" class="btn ok hide">Mettre √† jour maintenant</button>
      </div>

      <p class="muted">Cam√©ra : n√©cessite HTTPS ou <code>http://localhost</code>. Version <b>BarcodeDetector only</b>.</p>
    </section>
  </main>

  <footer>Made for CFA ‚Äî PWA hors-ligne. ¬© <span id="year"></span></footer>
  <script>document.getElementById('year').textContent = new Date().getFullYear();</script>

  <script src="js/db.js?v=1.6.1"></script>
  <script src="js/barcode.js?v=1.6.1"></script>
  <script src="js/app.js?v=1.6.1"></script>

  <!-- Gestion UI des mises √† jour (interagit avec sw.js) -->
  <script>
    (function(){
      if (!('serviceWorker' in navigator) || !location.protocol.startsWith('http')) return;
      let reg = null;

      function $(id){ return document.getElementById(id); }
      const box = $('updateBox'), status = $('updateStatus'), btnCheck = $('btnCheckUpdate'), btnApply = $('btnApplyUpdate');

      // R√©cup√®re l‚Äôinstance du SW d√©j√† enregistr√©e (par le script dans <head>)
      navigator.serviceWorker.getRegistration('./sw.js').then(r=>{
        reg = r;
        wire();
      }).catch(()=>{ wire(); });

      function showApply(){
        if (status) status.textContent = 'Nouvelle version disponible.';
        if (btnApply) btnApply.classList.remove('hide');
      }

      function wire(){
        if (!reg){
          if (status) status.textContent = "Service Worker non actif.";
          return;
        }
        // Si une version est d√©j√† en attente
        if (reg.waiting) showApply();

        // Sur d√©couverte d‚Äôune nouvelle update
        reg.addEventListener('updatefound', ()=>{
          const installing = reg.installing;
          if (!installing) return;
          installing.addEventListener('statechange', ()=>{
            if (installing.state === 'installed' && navigator.serviceWorker.controller){
              showApply();
            }
          });
        });

        // Bouton "V√©rifier"
        if (btnCheck) btnCheck.addEventListener('click', async ()=>{
          if (status) status.textContent = 'Recherche de mise √† jour‚Ä¶';
          try{
            await reg.update(); // d√©clenche updatefound si nouvelle version
            if (!reg.waiting && status) status.textContent = 'Version actuelle charg√©e.';
          }catch(e){
            if (status) status.textContent = 'Erreur de v√©rification.';
          }
        });

        // Bouton "Mettre √† jour"
        if (btnApply) btnApply.addEventListener('click', ()=>{
          const waiting = reg.waiting;
          if (!waiting) return location.reload();
          waiting.postMessage({ type: 'SKIP_WAITING' });
          navigator.serviceWorker.addEventListener('controllerchange', ()=> location.reload());
        });
      }
    })();
  </script>
</body>
</html>
